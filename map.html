<script>
    // ... (keep your existing Leaflet initialization code)

    function notifyFlutter(lat, lng) {
        // Send location to Flutter
        if (window.LocationChannel) {
            window.LocationChannel.postMessage(JSON.stringify({
                lat: lat,
                lng: lng
            }));
        }
    }

    // Update locateUser function
    function locateUser() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    if (userMarker) map.removeLayer(userMarker);
                    
                    userMarker = L.marker([latitude, longitude])
                        .addTo(map)
                        .bindPopup("Your Location");
                    
                    map.setView([latitude, longitude], 15);
                    notifyFlutter(latitude, longitude);
                },
                error => {
                    console.error("Geolocation error:", error);
                    if (window.LocationChannel) {
                        window.LocationChannel.postMessage(JSON.stringify({
                            error: "Location access denied"
                        }));
                    }
                }
            );
        } else {
            if (window.LocationChannel) {
                window.LocationChannel.postMessage(JSON.stringify({
                    error: "Geolocation not supported"
                }));
            }
        }
    }

    // Initialize with Flutter communication
    if (window.LocationChannel) {
        window.addEventListener('flutterReady', function() {
            console.log("Flutter WebView ready");
        });
    }
</script>
